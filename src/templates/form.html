<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Únete al Club de Lectores</title>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <style>
    body {
      font-family: 'Georgia', serif;
      background-color: #fcfaf7;
      color: #333;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 30px;
      box-sizing: border-box;
    }

    .form-card {
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      border: 1px solid #e2d1c3;
      width: 100%;
      max-width: 400px;
    }

    h2 {
      text-align: center;
      color: #2c1810;
      border-bottom: 1px solid #e2d1c3;
      padding-bottom: 15px;
      margin-top: 0;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #5d4037;
      font-size: 0.9rem;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 6px;
      border: 1px solid #d1bfa7;
      border-radius: 4px;
      box-sizing: border-box;
      background-color: #fffaf5;
      transition: 0.2s;
    }

    input:focus {
      border-color: #8b5e3c;
      background-color: #fff;
      outline: none;
    }

    /* Estados de validación */
    .ok {
      border-color: #2e7d32 !important;
      background-color: #f2fbf3 !important;
    }

    .bad {
      border-color: #c62828 !important;
      background-color: #fff3f3 !important;
    }

    .msg {
      font-size: 0.82rem;
      margin: 0 0 14px 0;
      line-height: 1.25rem;
      color: #6b5b53;
      min-height: 18px;
    }

    .msg.ok {
      color: #2e7d32;
    }

    .msg.bad {
      color: #c62828;
    }

    .password-rules {
      font-size: 0.82rem;
      margin: 0 0 14px 0;
      color: #6b5b53;
    }

    .rule {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #c62828;
      flex: 0 0 auto;
      transition: 0.2s;
    }

    .rule.ok .dot {
      background: #2e7d32;
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Georgia', serif;
      font-size: 1rem;
      transition: 0.3s;
    }

    button[type="submit"] {
      background-color: #4a3728;
      color: white;
    }

    button[type="submit"]:hover {
      background-color: #3a2b1f;
    }

    button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-back {
      background-color: transparent;
      color: #8b5e3c;
      text-decoration: underline;
      font-size: 0.85rem;
    }

    .captcha-msg {
      margin-top: 10px;
      font-size: 0.82rem;
      min-height: 18px;
    }
  </style>
</head>

<body>
  <div class="form-card">
    <h2>Club de Lectores</h2>

    <form id="formRegistro" action="/crear_usuario" method="post">
      <label for="usuario">Nombre de Usuario (4-15 caracteres)</label>
      <input type="text" id="usuario" name="usuario" minlength="4" maxlength="15" required>
      <div id="msgUsuario" class="msg"></div>

      <label for="email">Correo Electrónico</label>
      <input type="email" id="email" name="email" required>
      <div id="msgEmail" class="msg"></div>

      <label for="pass1">Contraseña</label>
      <input type="password" id="pass1" name="password" minlength="8" required>

      <div class="password-rules">
        <div id="rLen" class="rule"><span class="dot"></span> Mínimo 8 caracteres</div>
        <div id="rUpper" class="rule"><span class="dot"></span> Al menos 1 mayúscula</div>
        <div id="rLower" class="rule"><span class="dot"></span> Al menos 1 minúscula</div>
        <div id="rNum" class="rule"><span class="dot"></span> Al menos 1 número</div>
      </div>

      <label for="pass2">Confirmar Contraseña</label>
      <input type="password" id="pass2" required>
      <div id="msgPass2" class="msg"></div>

      <div class="g-recaptcha" data-sitekey="6Lcr9WUsAAAAAC2pV7Uwh6FTjY1BvMDo4NYP9fx0"></div>
      <div id="msgCaptcha" class="captcha-msg msg"></div>

      <div class="actions">
        <button id="btnSubmit" type="submit" disabled>Crear Cuenta</button>
        <button type="button" class="btn-back" onclick="location.href='/pantalla1'">
          Volver al inicio
        </button>
      </div>
    </form>
  </div>

  <script>
    const form = document.getElementById("formRegistro");
    const btnSubmit = document.getElementById("btnSubmit");

    const usuario = document.getElementById("usuario");
    const email = document.getElementById("email");
    const pass1 = document.getElementById("pass1");
    const pass2 = document.getElementById("pass2");

    const msgUsuario = document.getElementById("msgUsuario");
    const msgEmail = document.getElementById("msgEmail");
    const msgPass2 = document.getElementById("msgPass2");
    const msgCaptcha = document.getElementById("msgCaptcha");

    const rLen = document.getElementById("rLen");
    const rUpper = document.getElementById("rUpper");
    const rLower = document.getElementById("rLower");
    const rNum = document.getElementById("rNum");

    // Regex de usuario: letras, números, guión bajo. 4 a 15.
    const reUsuario = /^[a-zA-Z0-9_]{4,15}$/;

    function setFieldState(input, msgEl, ok, message) {
      input.classList.remove("ok", "bad");
      msgEl.classList.remove("ok", "bad");

      if (ok === null) {
        msgEl.textContent = message || "";
        return;
      }

      if (ok) {
        input.classList.add("ok");
        msgEl.classList.add("ok");
      } else {
        input.classList.add("bad");
        msgEl.classList.add("bad");
      }

      msgEl.textContent = message;
    }

    function validarUsuario() {
      const u = usuario.value.trim();

      if (u.length === 0) {
        setFieldState(usuario, msgUsuario, null, "");
        return false;
      }

      if (u.length < 4) {
        setFieldState(usuario, msgUsuario, false, "Te faltan caracteres (mínimo 4).");
        return false;
      }

      if (u.length > 15) {
        setFieldState(usuario, msgUsuario, false, "Te pasaste: máximo 15 caracteres.");
        return false;
      }

      if (!reUsuario.test(u)) {
        setFieldState(usuario, msgUsuario, false, "Solo letras, números y guión bajo (_).");
        return false;
      }

      setFieldState(usuario, msgUsuario, true, "Usuario válido.");
      return true;
    }

    function validarEmail() {
      const e = email.value.trim();

      if (e.length === 0) {
        setFieldState(email, msgEmail, null, "");
        return false;
      }

      // Validación mínima (el input type=email ya hace bastante)
      if (!e.includes("@") || !e.includes(".")) {
        setFieldState(email, msgEmail, false, "Correo inválido.");
        return false;
      }

      setFieldState(email, msgEmail, true, "Correo válido.");
      return true;
    }

    function validarPassword() {
      const p = pass1.value;

      const okLen = p.length >= 8;
      const okUpper = /[A-Z]/.test(p);
      const okLower = /[a-z]/.test(p);
      const okNum = /[0-9]/.test(p);

      rLen.classList.toggle("ok", okLen);
      rUpper.classList.toggle("ok", okUpper);
      rLower.classList.toggle("ok", okLower);
      rNum.classList.toggle("ok", okNum);

      pass1.classList.remove("ok", "bad");
      if (p.length === 0) return false;

      const ok = okLen && okUpper && okLower && okNum;
      pass1.classList.add(ok ? "ok" : "bad");
      return ok;
    }

    function validarConfirmacion() {
      const p1 = pass1.value;
      const p2 = pass2.value;

      if (p2.length === 0) {
        setFieldState(pass2, msgPass2, null, "");
        return false;
      }

      if (p1 !== p2) {
        setFieldState(pass2, msgPass2, false, "Las contraseñas no coinciden.");
        return false;
      }

      
      if (!validarPassword()) {
        setFieldState(pass2, msgPass2, false, "Primero completa una contraseña fuerte.");
        return false;
      }

      setFieldState(pass2, msgPass2, true, "Contraseñas coinciden.");
      return true;
    }

    function validarCaptcha() {
      const ok = grecaptcha.getResponse().length > 0;

      msgCaptcha.classList.remove("ok", "bad");

      if (!ok) {
        msgCaptcha.classList.add("bad");
        msgCaptcha.textContent = "Falta verificar el captcha.";
        return false;
      }

      msgCaptcha.classList.add("ok");
      msgCaptcha.textContent = "Captcha verificado.";
      return true;
    }

    function validarTodo() {
      const okU = validarUsuario();
      const okE = validarEmail();
      const okP = validarPassword();
      const okC = validarConfirmacion();
      const okCap = validarCaptcha();

      const ok = okU && okE && okP && okC && okCap;
      btnSubmit.disabled = !ok;
      return ok;
    }

    // Eventos
    usuario.addEventListener("input", () => { validarUsuario(); validarTodo(); });
    email.addEventListener("input", () => { validarEmail(); validarTodo(); });
    pass1.addEventListener("input", () => { validarPassword(); validarConfirmacion(); validarTodo(); });
    pass2.addEventListener("input", () => { validarConfirmacion(); validarTodo(); });

    // Captcha
    setInterval(() => {
      validarTodo();
    }, 800);

    
    form.addEventListener("submit", (e) => {
      if (!validarTodo()) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
